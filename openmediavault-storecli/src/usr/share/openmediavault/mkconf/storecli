#!/usr/bin/env bash
set -euo pipefail

SERVICE="storecli"

. /usr/share/openmediavault/scripts/helper-functions

config_get() {
        omv_config_get "/config/services/${SERVICE}/$1"
}

resolve_binary() {
        local primary fallback
        primary="$(config_get binary)"
        fallback="$(config_get fallback)"
        if command -v "$primary" >/dev/null 2>&1; then
                printf '%s' "$(command -v "$primary")"
                return 0
        fi
        if command -v "$fallback" >/dev/null 2>&1; then
                printf '%s' "$(command -v "$fallback")"
                return 0
        fi
        echo "storecli: no compatible binary found" >&2
        exit 1
}

run_command() {
        local bin
        bin="$(resolve_binary)"
        "$bin" "$@"
}

status_cmd() {
        run_command "/call" "show"
}

events_cmd() {
        run_command "/call" "show" "events"
}

usage() {
        cat <<EOF_USAGE
Usage: $0 <status|events>
EOF_USAGE
}

main() {
        local action="${1:-status}"
        case "$action" in
                status)
                        status_cmd
                        ;;
                events)
                        events_cmd
                        ;;
                *)
                        usage >&2
                        exit 1
                        ;;
        esac
}

main "$@"
