#!/usr/bin/env bash
set -euo pipefail

SERVICE="gitea"

. /usr/share/openmediavault/scripts/helper-functions

config_get() {
        local key="$1"
        omv_config_get "/config/services/${SERVICE}/${key}"
}

log_info() {
        omv_log "$SERVICE" "$1"
}

require_command() {
        if ! command -v "$1" >/dev/null 2>&1; then
                echo "${SERVICE}: missing dependency '$1'" >&2
                exit 1
        fi
}

generate_secret() {
        tr -dc 'A-Za-z0-9' </dev/urandom | head -c "${1:-32}"
}

compose_dir() {
        local path
        path="$(config_get composepath)"
        if [ -z "$path" ]; then
                path="/srv/dev-disk-by-label-data/${SERVICE}"
        fi
        printf '%s' "$path"
}

ensure_env_file() {
        local dir="$1"
        local env_file="$dir/.env"
        if [ -f "$env_file" ]; then
                return 0
        fi

        mkdir -p "$dir"
        local tz
        tz="$(config_get timezone)"
        if [ -z "$tz" ] && [ -f /etc/timezone ]; then
                tz="$(cat /etc/timezone)"
        fi
        if [ -z "$tz" ]; then
                tz="UTC"
        fi

        cat >"$env_file" <<EOF_ENV
TZ=${tz}
GITEA_DB_USER=gitea
GITEA_DB_PASSWORD=$(generate_secret 24)
GITEA_DB_NAME=gitea
GITEA_ADMIN_USERNAME=admin
GITEA_ADMIN_PASSWORD=$(generate_secret 24)
GITEA_ADMIN_EMAIL=admin@example.com
EOF_ENV
        chmod 600 "$env_file"
        log_info "Created default environment at $env_file"
}

write_compose() {
        local dir="$1"
        local compose_file="$dir/docker-compose.yml"
        local http_port ssh_port
        http_port="$(config_get httpport)"
        ssh_port="$(config_get sshport)"
        cat >"$compose_file" <<EOF_YAML
name: ${SERVICE}

services:
  gitea:
    image: gitea/gitea:1.22
    env_file:
      - .env
    environment:
      USER_UID: "1000"
      USER_GID: "100"
      DB_TYPE: postgres
      DB_HOST: postgres:5432
      DB_NAME: ${GITEA_DB_NAME}
      DB_USER: ${GITEA_DB_USER}
      DB_PASSWD: ${GITEA_DB_PASSWORD}
      GITEA__server__DOMAIN: ${GITEA_DOMAIN:-localhost}
      GITEA__database__SSL_MODE: disable
      GITEA__mailer__ENABLED: "false"
      GITEA__server__SSH_DOMAIN: ${GITEA_DOMAIN:-localhost}
      GITEA__security__INSTALL_LOCK: "true"
    volumes:
      - ./gitea:/data
    ports:
      - "${http_port}:3000"
      - "${ssh_port}:22"
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:15
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${GITEA_DB_USER}
      POSTGRES_PASSWORD: ${GITEA_DB_PASSWORD}
      POSTGRES_DB: ${GITEA_DB_NAME}
    volumes:
      - ./postgres:/var/lib/postgresql/data
    restart: unless-stopped
EOF_YAML
        log_info "Rendered compose file at $compose_file"
}

compose_cmd() {
        local dir="$1"
        shift
        (cd "$dir" && COMPOSE_PROJECT_NAME="$SERVICE" docker compose -f docker-compose.yml "$@")
}

install_stack() {
        require_command docker
        local dir
        dir="$(compose_dir)"
        mkdir -p "$dir/gitea" "$dir/postgres"
        ensure_env_file "$dir"
        write_compose "$dir"
        log_info "Deploying Gitea"
        compose_cmd "$dir" pull
        compose_cmd "$dir" up -d
}

remove_stack() {
        local dir="$(compose_dir)"
        if [ -f "$dir/docker-compose.yml" ]; then
                compose_cmd "$dir" down --remove-orphans || true
                log_info "Removed Gitea containers"
        fi
}

restart_stack() {
        local dir="$(compose_dir)"
        compose_cmd "$dir" up -d --remove-orphans
        log_info "Restarted Gitea"
}

status_stack() {
        local dir="$(compose_dir)"
        compose_cmd "$dir" ps
}

logs_stack() {
        local dir="$(compose_dir)"
        compose_cmd "$dir" logs --tail=200
}

usage() {
        cat <<EOF_USAGE
Usage: $0 <install|remove|restart|status|logs>
EOF_USAGE
}

main() {
        local action="${1:-status}"
        case "$action" in
                install)
                        install_stack
                        ;;
                remove)
                        remove_stack
                        ;;
                restart)
                        restart_stack
                        ;;
                status)
                        status_stack
                        ;;
                logs)
                        logs_stack
                        ;;
                *)
                        usage >&2
                        exit 1
                        ;;
        esac
}

main "$@"
